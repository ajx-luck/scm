---- C:\mcuproject\scm\xfx\CMS79F123程序（C版）\Usart_Demo\Async_Usart_Demo.c ----------------------------------------------------------------------
1:                /*-------------------------------------------
2:                
3:                程序名称：Usart异步收发程序演示
4:                版本：V1.0
5:                日期：2020.06.20 
6:                
7:                备注：
8:                
9:                *本程序由 中微半导体 &应用支持部& 编写整理
10:               *公司网址 www.mcu.com.cn
11:               *技术支持QQ 3001082102  罗工
12:                           3001030138	莫工
13:               -------------------------------------------*/
14:               
15:               
16:               #include <cms.h>
17:               
18:               
19:               //--------------------------------------
20:               //发送/接收数组定义
21:               unsigned char Recebuffer[4];	//接收数据缓存
22:               unsigned char Sendbuffer[4];	//发送数据缓存
23:               
24:               //--------------------------------------
25:               //函数声明部分
26:               void Set_Usart_Async();			//异步USART初始化设置函数
27:               
28:               //--------------------------------------
29:               unsigned char sendcount = 0,rececount = 0;
30:               
31:               //--------------------------------------
32:               //测试示例
33:               
34:               
35:               void main()
  001C    0000    NOP
  001D    0064    CLRWDT
36:               {
37:               	asm("nop");
38:               	asm("clrwdt");
39:               	
40:               	OSCCON = 0x71;				//内部振荡器用作系统时钟
  001E    3071    LDIA	0x71
  001F    1683    SETB	0x3,5
  0020    1303    CLRB	0x3,6
  0021    008F    LD	0xF,A
41:               	INTCON = 0;
  0022    018B    CLR	0xB
42:               	
43:               	PIR1 = 0;
  0023    1283    CLRB	0x3,5
  0024    018C    CLR	0xC
44:               	PIE1 = 0;
  0025    1683    SETB	0x3,5
  0026    018C    CLR	0xC
45:               	PIR2 = 0;
  0027    1283    CLRB	0x3,5
  0028    018D    CLR	0xD
46:               	PIE2 = 0;
  0029    1683    SETB	0x3,5
  002A    018D    CLR	0xD
47:               	
48:               	TRISA = 0B00000000;
  002B    0185    CLR	0x5
49:               	PORTA = 0B00000000;
  002C    1283    CLRB	0x3,5
  002D    0185    CLR	0x5
50:               
51:               	/*初始化USART通信模块*/
52:               	Set_Usart_Async();
  002E    118A    CLRB	0xA,3
  002F    2067    CALL	0x67
  0030    118A    CLRB	0xA,3
53:               
54:               	
55:               	INTCON = 0XC0;				//全局中断使能
  0031    30C0    LDIA	0xC0
  0032    008B    LD	0xB,A
56:               	
57:               	
58:               	while(1)
  0033    0064    CLRWDT
59:               	{
60:               		asm("clrwdt");	
61:               		
62:               		PORTA = Recebuffer[0];
  0034    0874    LD	A,0x74
  0035    1283    CLRB	0x3,5
  0036    1303    CLRB	0x3,6
  0037    0085    LD	0x5,A
63:               		
64:               		//-------------------------------------------
65:               /*发送控制亦可选择使用发送中断（TXIE）来控制发送，
66:               有待发送数据时将TXIE置1，最后一个字符写入TXREG后，将TXIE中断允许位清零。*/				
67:               		//发送控制		
68:               		if(TRMT)
  0038    1683    SETB	0x3,5
  0039    1C98    SNZB	0x18,1
  003A    2833    JP	0x33
69:               		{
70:               			TXREG = Sendbuffer[sendcount];	                       
  003B    0879    LD	A,0x79
  003C    3E70    ADDIA	0x70
  003D    0084    LD	0x4,A
  003E    0800    LD	A,0x0
  003F    1283    CLRB	0x3,5
  0040    0099    LD	0x19,A
71:               			
72:               			Sendbuffer[sendcount] ++;
  0041    0879    LD	A,0x79
  0042    3E70    ADDIA	0x70
  0043    0084    LD	0x4,A
  0044    3004    LDIA	0x4
  0045    0A80    INCR	0x0
73:               			
74:               			sendcount++;
  0046    0AF9    INCR	0x79
75:               			if(sendcount >= 4)
  0047    0279    SUBA	0x79
  0048    1C03    SNZB	0x3,0
  0049    2833    JP	0x33
76:               			{
77:               				sendcount = 0;
  004A    01F9    CLR	0x79
  004B    2833    JP	0x33
78:               			}
79:               		}
80:               		
81:               	}
82:               }
83:               
84:               
85:               //--------------------------------------
86:               //中断服务
87:               void interrupt Usart_Isr()
88:               {
89:               	static unsigned char tcount = 0;
90:               
91:               	
92:               	//-------------------------------------------
93:               	//接收控制，如果接收标志位为1，说明有数据接收完毕
94:               	//RCIF在寄存器被读出后自动清零
95:               	if(RCIF)
  004C    1283    CLRB	0x3,5
  004D    1303    CLRB	0x3,6
  004E    1E8C    SNZB	0xC,5
  004F    285E    JP	0x5E
96:               	{	
97:               		
98:               		
99:               		Recebuffer[rececount] = RCREG;  	//将接收缓冲区内容读出
  0050    0878    LD	A,0x78
  0051    3E74    ADDIA	0x74
  0052    0084    LD	0x4,A
  0053    081A    LD	A,0x1A
  0054    0080    LD	0x0,A
  0055    3004    LDIA	0x4
100:              		rececount++;
  0056    0AF8    INCR	0x78
101:              			
102:              		if(rececount >= 4)					//接收完一帧数据，处理数据
  0057    0278    SUBA	0x78
  0058    1803    SZB	0x3,0
103:              		{
104:              			rececount = 0;
  0059    01F8    CLR	0x78
105:              		}
106:              			
107:              		if(OERR)							//如果有溢出错误
  005A    1C98    SNZB	0x18,1
  005B    285E    JP	0x5E
108:              		{
109:              			CREN = 0;						//清零CREN位可将OERR位清零
  005C    1218    CLRB	0x18,4
110:              			CREN = 1;						//再次将CREN置一，以允许继续接收
  005D    1618    SETB	0x18,4
  005E    087C    LD	A,0x7C
  005F    008A    LD	0xA,A
  0060    087B    LD	A,0x7B
  0061    0084    LD	0x4,A
  0062    0E7A    SWAPA	0x7A
  0063    0083    LD	0x3,A
  0064    0EFE    SWAPR	0x7E
  0065    0E7E    SWAPA	0x7E
  0066    0009    RETI
111:              		}
112:              		
113:              	}
114:              }
115:              
116:              /***********************************************
117:              函数名称：Set_Usart_Async
118:              函数功能：Usart状态设置（异步）
119:              入口参数：无
120:              出口参数：无
121:              备注：
122:              1、串口通讯，设置波特率寄存器时，应控制在19200及以下，实际应用时应考虑到芯片内振的电压及温度特性。
123:              2、SYNC = 0;目标波特率 = Fosc/(16*(SPBRG+1))
124:              ************************************************/
125:              void Set_Usart_Async()
126:              {
127:              	SPBRG = 95;			//设置波特率为10417 bps，误差0%	
  0067    305F    LDIA	0x5F
  0068    1683    SETB	0x3,5
  0069    0099    LD	0x19,A
128:              	
129:              	SYNC = 0;				//0为异步模式，1为同步模式
  006A    1218    CLRB	0x18,4
130:              	SCKP = 0;
  006B    1198    CLRB	0x18,3
131:              	
132:                  SPEN = 1;				//允许串口操作
  006C    1283    CLRB	0x3,5
  006D    1798    SETB	0x18,7
133:              	RCIE = 1;				//接收中断  
  006E    1683    SETB	0x3,5
  006F    168C    SETB	0xC,5
134:              	TXIE = 0;				//发送中断
  0070    120C    CLRB	0xC,4
135:                  RX9EN = 0;				//0为8位接收，1为9位接收
  0071    1283    CLRB	0x3,5
  0072    1318    CLRB	0x18,6
136:              	TX9EN = 0;				//0为8位发送，1为9位发送
  0073    1683    SETB	0x3,5
  0074    1318    CLRB	0x18,6
137:              	CREN = 1;				//0为禁止接收，1为使能接收
  0075    1283    CLRB	0x3,5
  0076    1618    SETB	0x18,4
138:                  TXEN = 1;				//0为禁止发送，1为使能发送
  0077    1683    SETB	0x3,5
  0078    1698    SETB	0x18,5
  0079    0008    RET
139:              }
---- stringtab ------------------------------------------------------------------
---- reset_enter ------------------------------------------------------------------
  0000    118A    CLRB	0xA,3
  0001    280D    JP	0xD
  000D    118A    CLRB	0xA,3
  000E    280F    JP	0xF
---- start_initialization ------------------------------------------------------------------
  000F    01F0    CLR	0x70
  0010    01F1    CLR	0x71
  0011    01F2    CLR	0x72
  0012    01F3    CLR	0x73
  0013    01F4    CLR	0x74
  0014    01F5    CLR	0x75
  0015    01F6    CLR	0x76
  0016    01F7    CLR	0x77
  0017    01F8    CLR	0x78
  0018    01F9    CLR	0x79
---- interrupt_function_enter ----------------------------------------------------------
  0004    00FE    LD	0x7E,A
  0005    0E03    SWAPA	0x3
  0006    00FA    LD	0x7A,A
  0007    0804    LD	A,0x4
  0008    00FB    LD	0x7B,A
  0009    080A    LD	A,0xA
  000A    00FC    LD	0x7C,A
  000B    118A    CLRB	0xA,3
  000C    284C    JP	0x4C
---- common_function ------------------------------------------------------------------
  0019    0183    CLR	0x3
  001A    118A    CLRB	0xA,3
  001B    281C    JP	0x1C
